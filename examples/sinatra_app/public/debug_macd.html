<!DOCTYPE html>
<html>
<head>
    <title>MACD Debug Test</title>
</head>
<body>
    <h1>MACD API Debug Test</h1>
    <p>Testing indicators API response...</p>
    <pre id="output"></pre>

    <script>
        async function testMACDData() {
            const output = document.getElementById('output');

            try {
                const response = await fetch('/api/indicators/AAPL?period=90d');
                const data = await response.json();

                if (data.error) {
                    output.textContent = 'ERROR: ' + data.error;
                    return;
                }

                let debug = '';
                debug += 'Total dates: ' + data.dates.length + '\n';
                debug += 'Total MACD values: ' + data.macd.length + '\n\n';

                // Check for null/NaN values
                let nullCount = 0;
                let validCount = 0;
                let firstValidIndex = -1;

                for (let i = 0; i < data.macd.length; i++) {
                    if (data.macd[i] === null || isNaN(data.macd[i]) ||
                        data.macd_signal[i] === null || isNaN(data.macd_signal[i]) ||
                        data.macd_hist[i] === null || isNaN(data.macd_hist[i])) {
                        nullCount++;
                    } else {
                        validCount++;
                        if (firstValidIndex === -1) firstValidIndex = i;
                    }
                }

                debug += 'Null/NaN values: ' + nullCount + '\n';
                debug += 'Valid values: ' + validCount + '\n';
                debug += 'First valid index: ' + firstValidIndex + '\n\n';

                if (validCount > 0) {
                    debug += 'First 5 valid MACD values:\n';
                    let count = 0;
                    for (let i = firstValidIndex; i < data.macd.length && count < 5; i++) {
                        if (data.macd[i] !== null && !isNaN(data.macd[i])) {
                            debug += `  [${i}] Date: ${data.dates[i]}, MACD: ${data.macd[i]}, Signal: ${data.macd_signal[i]}, Hist: ${data.macd_hist[i]}\n`;
                            count++;
                        }
                    }

                    debug += '\nLast 5 MACD values:\n';
                    for (let i = Math.max(0, data.macd.length - 5); i < data.macd.length; i++) {
                        debug += `  [${i}] Date: ${data.dates[i]}, MACD: ${data.macd[i]}, Signal: ${data.macd_signal[i]}, Hist: ${data.macd_hist[i]}\n`;
                    }
                } else {
                    debug += '\nNO VALID MACD DATA FOUND!\n';
                    debug += '\nSample of raw data:\n';
                    for (let i = 0; i < Math.min(10, data.macd.length); i++) {
                        debug += `  [${i}] MACD: ${data.macd[i]} (type: ${typeof data.macd[i]}), `;
                        debug += `Signal: ${data.macd_signal[i]} (type: ${typeof data.macd_signal[i]}), `;
                        debug += `Hist: ${data.macd_hist[i]} (type: ${typeof data.macd_hist[i]})\n`;
                    }
                }

                output.textContent = debug;

            } catch (error) {
                output.textContent = 'ERROR: ' + error.message + '\n' + error.stack;
            }
        }

        testMACDData();
    </script>
</body>
</html>
